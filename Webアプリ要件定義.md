# 参加者CSV集計ツール（静的Webアプリ）仕様書

作成日: 2026-02-23  
対象: コーディングツール・実装担当者向け  
目的: Excel/VBA不要で、ブラウザ上で複数CSVを投入して参加回数と各種集計値を算出し、端末へCSV成果物として出力する。

---

## 1. 背景・目的

- 既存のVBAツールはExcel利用が前提で、Excelを使えない人に展開しづらい。
- ブラウザで完結する静的Webアプリとして提供し、各ユーザーが自端末で集計・成果物CSVを保存できる形にする。
- 集計の再現性と確実性を優先し、**集計のたびに全イベント分のCSVを投入**する運用とする。

---

## 2. 方式（アーキテクチャ）

- **静的Webアプリ（HTML/JS/CSS）** として実装する。
- サーバ不要（例: GitHub Pages / Cloudflare Pages 等でホスティング可能）。
- 入力はユーザーがブラウザでCSVファイルを選択またはドラッグ&ドロップ。
- 出力はブラウザから **CSVファイルをダウンロード**（端末内に保存）。
- ブラウザ内永続化（IndexedDB等）は必須要件ではない（毎回全投入運用のため）。

---

## 3. 用語定義

- **イベント**: 1つのCSVファイルを1イベントとして扱う。
- **主キー**: 個人判別に用いるID列（例: api_id）。
- **ステータス**: 申込/参加状態を表す列（例: approval_status）。
- **条件文字列**: 「参加扱い（+1）」に該当するステータス値（例: approved）。※入力必須
- **延べ人数**: イベントごとの「実際に参加扱い（条件一致）」の人数を合計したもの（同一人物が複数イベント参加なら複数カウント）。
- **ユニーク人数**: 期間全体で「実際に参加扱い（条件一致）」となった人物のユニーク数。
- **総申込人数**: イベントごとの申込人数（ステータスに関係なく、主キーが存在する行を人数として数える）を合計したもの。
- **実質参加割合**: `延べ人数 / 総申込人数`（小数）。総申込人数=0の場合は空または0。

---

## 4. 入力仕様

### 4.1 CSVファイル投入

- 複数CSVファイルを一括で投入できること。
  - 手段: (1) ファイル選択ボタン, (2) ドラッグ&ドロップ
- 文字コード: UTF-8 を前提（ただし、読み込み時は可能な範囲で柔軟に対応してもよい）。

### 4.2 列指定方法（必須要件）

- 列名指定ではなく、**列位置（アルファベット）**で指定する。
  - 例: A列, B列, ... , Z列, AA列, AB列, ...
- 指定対象（すべて必須）
  - 主キー列（例: A）
  - 名前列（例: B）
  - ステータス列（例: F）
  - +1カウントする条件文字列（例: approved） ※入力必須

### 4.3 条件文字列の比較ルール

- 入力された条件文字列とステータス値を比較して判定する。
- 推奨: 前後空白除去 + 大文字小文字を無視して比較
  - 例: `trim()` + `toLowerCase()` 相当
- ただし、実装側で厳密一致にしたい場合は、UIで注意書きを表示すること。

---

## 5. 二重集計防止仕様（ファイル名重複検知）

- 同一バッチ投入の中で **ファイル名が同一のCSVが複数存在する場合**、当該ファイル名のCSVは **全て集計対象から除外（スキップ）**する。
- スキップしたファイル名の一覧を画面表示し、出力にも含める（skipped_files.csv）。

> 注: OS側の自動連番（例: `xxx (1).csv`）はファイル名が異なるため重複検知には掛からない。運用上、イベント日付等をファイル名に含めることを推奨。

---

## 6. 集計仕様

### 6.1 前提

- 1CSV = 1イベント
- **集計のたびに全イベントCSVを投入**する（差分投入はしない）

### 6.2 行の正当性（バリデーション）

- 主キー・名前は必須
  - 主キーが空の行: 集計対象外（無視）
  - 名前が空の行: 集計対象外（無視）
- ステータスが空の行:
  - 「総申込人数」には含める（主キー/名前があれば1件）
  - 「延べ人数」「参加回数」には含めない（条件一致しないため）

※「処理停止」ではなく「無視＋件数カウントしてサマリ出力」を推奨（運用上詰まりにくい）。

### 6.3 参加回数（master_counts）の加算ルール

- 条件一致（ステータス == 条件文字列）の行のみ「参加扱い」とする。
- **イベント内で主キーをユニーク化**する（同一イベント内で同一人物が複数行あっても +1 は最大1回）
  - 手順例:
    1. 条件一致行を抽出
    2. 主キーでSet化
    3. Setの各主キーに対し `total_count += 1`
- 名前の扱い:
  - 出力は必須列。
  - 同一主キーの名前が揺れる可能性があるため、推奨ルール:
    - 初回に出現した名前を採用し、以後は上書きしない
  - 代替として「最新で上書き」も可能だが、仕様として採用しない（表記揺れ事故のリスク）。

### 6.4 集計指標の定義

- **総申込人数（gross_applications_total）**
  - 各イベントについて、主キーと名前が有効な行のユニーク主キー数（イベント内ユニーク）を「当該イベントの申込人数」とする。
  - それを全イベントで合算する。
  - 例: `gross_applications_total = Σ (unique_applicants_per_event)`

- **延べ人数（attended_total）**
  - 各イベントについて、条件一致かつ主キーと名前が有効な行のユニーク主キー数（イベント内ユニーク）を「当該イベントの参加人数」とする。
  - それを全イベントで合算する。
  - 例: `attended_total = Σ (unique_attendees_per_event)`

- **ユニーク人数（attended_unique_people）**
  - 全イベント横断で「条件一致した主キー」のユニーク数。
  - 例: `attended_unique_people = |Union(attendees_per_event)|`

- **実質参加割合（effective_attendance_rate）**
  - `effective_attendance_rate = attended_total / gross_applications_total`
  - `gross_applications_total == 0` の場合は空 or 0（実装で統一する）

---

## 7. 出力仕様（CSV）

### 7.1 出力ファイル一覧

1. `master_counts.csv`（必須）
2. `summary.csv`（必須）
3. `skipped_files.csv`（必須）
4. （任意）`errors.csv`（推奨：無視行の詳細が必要なら）

### 7.2 master_counts.csv 仕様

- ヘッダ:
  - `primary_key,name,total_count`
- 並び順:
  - `total_count` 降順、同数は `primary_key` 昇順（推奨）

### 7.3 summary.csv 仕様

- 1行の集計サマリを出力（ヘッダ付き）
- ヘッダ例:
  - `generated_at,processed_files,skipped_files,gross_applications_total,attended_total,attended_unique_people,effective_attendance_rate,ignored_rows_missing_key,ignored_rows_missing_name`
- generated_at:
  - ISO 8601 形式推奨（例: `2026-02-23T14:30:00+09:00`）

### 7.4 skipped_files.csv 仕様

- ヘッダ:
  - `file_name,reason`
- reason:
  - `duplicate_filename` 固定

### 7.5 CSV出力の基本方針

- 文字コード: UTF-8
- 改行: LF 推奨
- 値のエスケープ: RFC 4180 相当（カンマ/改行/ダブルクォート含む場合はクォート）

---

## 8. UI仕様（最小要件）

### 8.1 画面構成（単一ページ）

- ファイル投入エリア（D&D）
- ファイル選択ボタン
- 設定入力（必須）
  - 主キー列: 文字入力（例: `A` / `AA`）
  - 名前列: 文字入力
  - ステータス列: 文字入力
  - 条件文字列: テキスト入力（例: `approved`）
- 実行ボタン: 「集計する」
  - 必須入力が揃っていない場合はdisabled
- 結果表示
  - processed_files / skipped_files
  - gross_applications_total / attended_total / attended_unique_people / effective_attendance_rate
  - スキップされたファイル名一覧
- ダウンロードボタン
  - master_counts.csv
  - summary.csv
  - skipped_files.csv

### 8.2 エラー表示

- ファイル名重複でスキップが発生した場合:
  - 画面上に警告（スキップ一覧）
- CSVのパース失敗:
  - 当該ファイルを「エラー扱いでスキップ」し、画面とsummaryに反映（推奨）
  - reason例: `parse_error`（skipped_files.csvに拡張する場合）

---

## 9. 非機能要件

- ブラウザ: 最新のChromeを主対象（他はベストエフォート）
- 性能:
  - 数千〜数万行程度のCSV複数投入を想定（必要ならストリーミングパース採用）
- セキュリティ/プライバシー:
  - 入力CSVは端末内処理し、サーバ送信しない（静的Webで実現）
- 可搬性:
  - 出力はCSVダウンロードのため、ユーザーはDriveへ手動アップロードしてスプシで閲覧可能

---

## 10. テスト観点（最低限）

1. 単一イベント、approvedが1件のみ → total_count=1、延べ=1、総申込=行数（ユニーク）
2. 同一イベント内で同一主キーが複数行かつapprovedが複数 → +1は1回のみ
3. 複数イベントで同一人物がapproved → total_countがイベント数分増える
4. ファイル名重複（同名2ファイル） → 両方スキップ、集計に含めない
5. 主キー空行 / 名前空行 → 無視され、summaryのignored_rowsに反映
6. 条件文字列の大小文字・空白揺れ（例: `" Approved "`） → 正しく判定（trim/lowerが有効なら）

---

## 11. 付記（運用推奨）

- ファイル名に `YYYY-MM-DD_イベント名.csv` のように日付を含める運用を推奨（重複検知の実効性が上がる）。
- 条件文字列はイベント/環境で変わりうるため、毎回入力を必須とする。

---